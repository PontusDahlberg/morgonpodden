name: ğŸ™ï¸ MÃ¤nniska Maskin MiljÃ¶ - Podcast Generation

# KÃ¶r workflow varje dag kl 06:00 svensk tid eller manuellt
on:
  schedule:
    - cron: '0 4 * * *'  # 04:00 UTC = 06:00 svensk tid, varje dag
  workflow_dispatch:  # Manuell kÃ¶rning frÃ¥n GitHub Actions UI

env:
  PYTHON_VERSION: '3.11'
  TZ: Europe/Stockholm

jobs:
  test-code:
    name: ğŸ§ª Test Code Quality
    runs-on: ubuntu-latest
    continue-on-error: true  # â­ LÃ¥t detta jobb faila utan att stoppa andra
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || echo "âš ï¸ Some requirements failed, continuing..."
        pip install pytest black flake8 || echo "âš ï¸ Dev tools install failed, continuing..."
        
    - name: ğŸ” Code formatting check (non-blocking)
      run: |
        black --check --diff . || echo "âš ï¸ Code formatting issues found, but continuing..."
        
    - name: ğŸ” Lint code (non-blocking)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "âš ï¸ Linting issues found, but continuing..."
        
    - name: ğŸ§ª Basic syntax check
      run: |
        python -c "import sys; print(f'âœ… Python {sys.version} working')"
        echo "âœ… Basic tests passed"

  generate-podcast:
    name: ğŸ™ï¸ Generate Daily Podcast
    runs-on: ubuntu-latest
    # needs: test-code  # TillfÃ¤lligt inaktiverat fÃ¶r att fokusera pÃ¥ podcast-generering
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write  # BehÃ¶vs fÃ¶r att committa tillbaka till repo
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: â™»ï¸ Restore news dedupe history
      uses: actions/cache@v4
      with:
        path: news_history.json
        key: news-history-${{ github.ref_name }}-${{ github.run_id }}
        restore-keys: |
          news-history-${{ github.ref_name }}-

    - name: â™»ï¸ Restore public audio cache (keep previous episodes)
      uses: actions/cache@v4
      with:
        path: public/audio
        key: public-audio-${{ github.ref_name }}-${{ github.run_id }}
        restore-keys: |
          public-audio-${{ github.ref_name }}-
        
    - name: ğŸµ Ensure FFmpeg available
      shell: bash
      run: |
        set -euo pipefail
        if command -v ffmpeg >/dev/null 2>&1; then
          echo "âœ… ffmpeg already available"
          ffmpeg -version | head -n 3
          exit 0
        fi

        echo "ğŸ”§ Installing ffmpeg via apt..."
        sudo apt-get update
        sudo apt-get install -y ffmpeg

        echo "âœ… ffmpeg installed"
        ffmpeg -version | head -n 3
        
    - name: ğŸ”§ Configure secrets
      run: |
        echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> .env
        echo "USE_GOOGLE_CLOUD_TTS=true" >> .env
        
        # Skapa Google Cloud credentials fil frÃ¥n secret
        echo '${{ secrets.GOOGLE_CLOUD_KEY }}' > google-cloud-service-account.json
        
        # Debug: kolla att filen skapades korrekt
        echo "ğŸ“ Credentials fil skapad:"
        ls -la google-cloud-service-account.json
        echo "ğŸ“„ FÃ¶rsta rader av filen:"
        head -n 3 google-cloud-service-account.json

        echo "ğŸ” Project/service account info:"
        python - <<'PY'
        import json
        p = json.load(open('google-cloud-service-account.json', 'r', encoding='utf-8'))
        print('project_id=', p.get('project_id'))
        print('client_email=', p.get('client_email'))
        PY

    - name: ğŸ” Verify Gemini TTS access (multi-speaker)
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/google-cloud-service-account.json
        MMM_FORCE_GEMINI_TTS: ${{ vars.MMM_FORCE_GEMINI_TTS }}
      run: |
        set +e
        python - <<'PY'
        from google.cloud import texttospeech

        client = texttospeech.TextToSpeechClient()

        multi = texttospeech.MultiSpeakerVoiceConfig(
            speaker_voice_configs=[
                texttospeech.MultispeakerPrebuiltVoice(speaker_alias='Lisa', speaker_id='Gacrux'),
                texttospeech.MultispeakerPrebuiltVoice(speaker_alias='Pelle', speaker_id='Iapetus'),
            ]
        )

        voice = texttospeech.VoiceSelectionParams(
            language_code='sv-SE',
            model_name='gemini-2.5-pro-tts',
            multi_speaker_voice_config=multi,
        )

        audio_config = texttospeech.AudioConfig(
            audio_encoding=texttospeech.AudioEncoding.MP3,
            sample_rate_hertz=24000,
        )

        synthesis_input = texttospeech.SynthesisInput(
            text='Lisa: Hej! Pelle: Hej! Det hÃ¤r Ã¤r ett kort test.',
            prompt='Swedish news podcast. Natural Swedish pronunciation.'
        )

        resp = client.synthesize_speech(input=synthesis_input, voice=voice, audio_config=audio_config)
        print('âœ… Gemini TTS self-test ok, bytes=', len(resp.audio_content))
        PY
        status=$?
        if [ $status -ne 0 ]; then
          echo "âŒ Gemini TTS self-test failed (exit=$status)"
          case "${MMM_FORCE_GEMINI_TTS}" in
            1|true|TRUE|yes|YES|y|Y)
              echo "MMM_FORCE_GEMINI_TTS is enabled; failing workflow."
              exit $status
              ;;
            *)
              echo "Continuing (MMM_FORCE_GEMINI_TTS not enabled)."
              ;;
          esac
        fi
        
    - name: ğŸ“° Scrape fresh news content
      run: |
        echo "ğŸ“° Scraping fresh content from all sources..."
        python scrape_news.py
        echo "âœ… Fresh content scraped and saved"
        
    - name: ğŸ™ï¸ Generate podcast (Complete version)
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/google-cloud-service-account.json
        USE_GOOGLE_CLOUD_TTS: true
        TZ: Europe/Stockholm
        MMM_FORCE_GEMINI_TTS: ${{ vars.MMM_FORCE_GEMINI_TTS }}
        # Explicitly unset GOOGLE_CLOUD_KEY to force using file
        GOOGLE_CLOUD_KEY: ""

        # Optional: email quality report (SMTP via GitHub Secrets)
        MMM_REPORT_EMAIL_TO: ${{ secrets.MMM_REPORT_EMAIL_TO }}
        MMM_REPORT_EMAIL_FROM: ${{ secrets.MMM_REPORT_EMAIL_FROM }}
        MMM_REPORT_EMAIL_ENABLED: "true"
        SMTP_HOST: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        SMTP_USE_TLS: ${{ secrets.SMTP_USE_TLS }}
        SMTP_USE_SSL: ${{ secrets.SMTP_USE_SSL }}
      run: |
        echo "ğŸ” Debug environment:"
        echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"
        echo "GOOGLE_CLOUD_KEY is unset: $GOOGLE_CLOUD_KEY"
        ls -la google-cloud-service-account.json
        
        echo "ğŸ” Checking git info:"
        git log --oneline -5
        git status
        
        echo "ğŸ” Checking code version:"
        grep -n "BRUTAL FIX VERSION" google_cloud_tts.py || echo "âŒ New code not found!"
        grep -n "Service account konfigurerad frÃ¥n miljÃ¶variabel" google_cloud_tts.py || echo "No old text found"
        
        python run_podcast_complete.py

    - name: ğŸ§¹ Prune old public audio files (keep last 90)
      if: success()
      run: |
        set -e
        mkdir -p public/audio
        echo "Before prune:"; ls -1 public/audio | wc -l
        # BehÃ¥ll bara senaste 90 mp3-filerna i public/audio
        ls -1t public/audio/MMM_senaste_nytt_*.mp3 2>/dev/null | tail -n +91 | xargs -r rm -f
        echo "After prune:"; ls -1 public/audio | wc -l
        
    - name: ğŸ“ Upload podcast artifacts
      uses: actions/upload-artifact@v4
      with:
        name: daily-podcast-${{ github.run_number }}
        path: |
          audio/MMM_senaste_nytt_*.mp3
          public/audio/*.mp3
          public/feed.xml
          podcast_script_*.txt
          episodes/quality_report_*.md
          episodes/quality_report_*.json
          podcast_generation.log
          diagnostics.jsonl
        retention-days: 90
        if-no-files-found: warn
        
    - name: ï¿½ Commit generated podcast to repository
      if: success()
      run: |
        # Konfigurera Git
        git config user.name "Podcast Bot"
        git config user.email "action@github.com"
        
        # LÃ¤gg till nya filer
        git add audio/MMM_*.mp3 2>/dev/null || echo "Inga nya audio-filer"
        git add public/audio/*.mp3 2>/dev/null || echo "Inga nya public audio-filer"  
        git add public/feed.xml 2>/dev/null || echo "Ingen ny RSS-feed"
        git add podcast_script_*.txt 2>/dev/null || echo "Inga nya script-filer"
        git add episode_*.json 2>/dev/null || echo "Inga nya episode-filer"
        git add news_history.json 2>/dev/null || echo "Ingen news_history.json"
        
        # Kolla om det finns Ã¤ndringar att committa
        if git diff --staged --quiet; then
          echo "ğŸ“­ Inga nya Ã¤ndringar att committa"
        else
          # Committa Ã¤ndringar
          TODAY=$(date +'%Y-%m-%d')
          git commit -m "ğŸ™ï¸ Nytt podcast-avsnitt: $TODAY

          - Automatiskt genererat avsnitt  
          - Uppdaterad RSS-feed
          - Sparad i GitHub Pages fÃ¶r 90 dagar
          
          ğŸµ Lyssna: https://pontusdahlberg.github.io/morgonpodden/
          ğŸ“¡ RSS: https://pontusdahlberg.github.io/morgonpodden/feed.xml"
          
          git push
          echo "âœ… Committat och pushat nya avsnitt!"
        fi
        
    - name: ï¿½ğŸ”” Notify on success
      if: success()
      run: |
        echo "âœ… Podcast generated successfully!"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Download: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  deploy-website:
    name: ğŸŒ Deploy Podcast Website
    runs-on: ubuntu-latest
    needs: generate-podcast
    if: success() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“‚ Download podcast artifacts
      uses: actions/download-artifact@v4
      with:
        name: daily-podcast-${{ github.run_number }}
        path: ./
        
    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¤ Upload to Pages
      uses: actions/upload-pages-artifact@v4
      with:
        path: './public'
        
    - name: ğŸš€ Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
      
  notify-failure:
    name: ğŸš¨ Notify on Failure
    runs-on: ubuntu-latest
    needs: [generate-podcast, deploy-website]  # Tog bort test-code dependency
    if: failure()
    
    steps:
    - name: ğŸš¨ Send failure notification
      run: |
        echo "âŒ Podcast generation failed!"
        echo "ğŸ” Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        # HÃ¤r kan du lÃ¤gga till Slack/Discord/email-notifieringar
